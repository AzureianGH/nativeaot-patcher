<Project>

  <PropertyGroup>
    <!--
      Windows only: if not overridden, assume the global Cosmos.Patcher
      tool is installed at %USERPROFILE%\.dotnet\tools\cosmos.patcher.exe
    -->
    <CosmosPatcherExe Condition="'$(OS)'=='Windows_NT' and '$(CosmosPatcherExe)' == ''">$(USERPROFILE)\.dotnet\tools\cosmos.patcher.exe</CosmosPatcherExe>
  </PropertyGroup>

  <PropertyGroup>
    <PatchedAssembly />
    <EnablePatching Condition="'$(EnablePatching)'!='false'">true</EnablePatching>
    <EnableAOT>true</EnableAOT>
  </PropertyGroup>

  <UsingTask TaskName="Cosmos.Patcher.Build.Tasks.PatcherTask"
             AssemblyFile="$(CosmosPatcherTasksAssembly)" />

  <Target Name="Log" BeforeTargets="BeforeBuild">
    <Message Importance="High" Text="MSBuildThisFileDirectory: '$(MSBuildThisFileDirectory)'" />
    <Message Importance="High" Text="Configuration: '$(Configuration)'" />
    <Message Importance="High" Text="OutputPath: '$(OutputPath)'" />
    <Message Importance="High" Text="IntermediateOutputPath: '$(IntermediateOutputPath)'" />
    <Message Importance="High" Text="PatcherBuildDll: '$(PatcherBuildDll)'" />
    <Message Importance="High" Text="PatcherPath: '$(PatcherPath)'" />
    <Message Importance="High" Text="PatcherOutputPath: '$(PatcherOutputPath)'" />
    <Message Importance="High" Text="PatchedAssembly: '$(PatchedAssembly)'" />
    <Message Importance="High" Text="TargetFramework: '$(TargetFramework)'" />
    <Message Importance="High" Text="PatcherExists: Exists('$(PatcherPath)')" />
    <Message Importance="High" Text="PatcherTask:$(PatcherTask)" />
  </Target>

  <Target Name="SetupPatcher" AfterTargets="Build">
    <PropertyGroup>
      <PatcherOutputPath Condition="$(PatcherOutputPath) == ''">$(IntermediateOutputPath)/cosmos/ref/</PatcherOutputPath>
      <!-- The Main Assembly is patched to the root folder of Cosmos to make it easy to be found by other build tools -->
      <PatchedAssembly Condition="$(PatcherOutputPath) == ''">$(IntermediateOutputPath)/cosmos/$(AssemblyName)_patched.dll</PatchedAssembly>
    </PropertyGroup>

    <ItemGroup>
      <AssembliesToPatch Include="$(OutputPath)$(AssemblyName).dll">
        <PatcherOutputPath>$(IntermediateOutputPath)/cosmos/$(AssemblyName)_patched.dll</PatcherOutputPath>
      </AssembliesToPatch>
      <AssembliesToPatch Include="@(ReferencePathWithRefAssemblies)">
        <PatcherOutputPath>$(IntermediateOutputPath)/cosmos/ref/%(Filename).dll</PatcherOutputPath>
      </AssembliesToPatch>
    </ItemGroup>
    
    <ItemGroup>
      <PlugRef Include="$(OutputPath)/$(AssemblyName).dll" />
    </ItemGroup>
    
    <MakeDir Directories="$(PatcherOutputPath)" />
  </Target>

  <!-- Linux/macOS -->
  <Target Name="RunPatcher"
        AfterTargets="Build"
        DependsOnTargets="SetupPatcher"
        Condition="'$(OS)'!='Windows_NT' and '$(EnablePatching)' == 'true'"
        Inputs="@(AssembliesToPatch->'%(Identity)')"
        Outputs="@(AssembliesToPatch->'%(PatcherOutputPath)')">
    <Message Importance="High" Text="Batch patching: %(AssembliesToPatch.Identity) -> %(AssembliesToPatch.PatcherOutputPath)" />

    <Exec Command="cosmos.patcher patch --target &quot;@(AssembliesToPatch)&quot; --output &quot;%(AssembliesToPatch.PatcherOutputPath)&quot; --plugs @(PlugRef ->'%(Identity)')"
          IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="PatcherExitCode" />
      <Output TaskParameter="ConsoleOutput" PropertyName="PatcherConsoleOutput" />
    </Exec>

    <Error Condition="'$(PatcherExitCode)' != '0'" Text="Cosmos.Patcher failed for &quot;%(AssembliesToPatch.Identity)&quot; with code $(PatcherExitCode): $(PatcherConsoleOutput)" />

    <Message Importance="High" Text="Cosmos.Patcher successfully patched: '%(AssembliesToPatch.PatcherOutputPath)'" Condition="'$(PatcherExitCode)' == '0'" />
  </Target>

  <!-- Windows -->
  <Target Name="RunPatcher"
        AfterTargets="Build"
        DependsOnTargets="SetupPatcher"
        Condition="'$(OS)'=='Windows_NT' and '$(EnablePatching)' == 'true'"
        Inputs="@(AssembliesToPatch->'%(Identity)')"
        Outputs="@(AssembliesToPatch->'%(PatcherOutputPath)')">
    <Message Importance="High" Text="Batch patching: %(AssembliesToPatch.Identity) -> %(AssembliesToPatch.PatcherOutputPath)" />
    <Message Text="▶ Running Patch…" Importance="High" />
    <Exec
      Command="$(CosmosPatcherExe) patch --target &quot;@(AssembliesToPatch)&quot; --output &quot;%(AssembliesToPatch.PatcherOutputPath)&quot; --plugs @(PlugRef->'%(Identity)')"
      IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="PatcherExitCode" />
      <Output TaskParameter="ConsoleOutput" PropertyName="PatcherConsoleOutput" />
    </Exec>

    <Error Condition="'$(PatcherExitCode)' != '0'"
           Text="Cosmos.Patcher failed for &quot;%(AssembliesToPatch.Identity)&quot; code=$(PatcherExitCode): $(PatcherConsoleOutput)" />
    <Message Importance="High"
             Text="✅ Cosmos.Patcher successfully patched: %(AssembliesToPatch.PatcherOutputPath)"
             Condition="'$(PatcherExitCode)' == '0'" />
  </Target>

</Project>
